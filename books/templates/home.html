{% extends 'index.html' %}

{% block booktable %}
    {% load rest_framework %}
    {{all_fields}}

    <div>
        {% for row in all_fields %}
            <div>
                <input type="checkbox" name="{{row.column_name}}" {% if row.is_visible %} checked {%endif%} onclick="change_visible({{row.id}}, '{{row.is_visible}}');">
                <label for="{{row.column_name}}">{{row.column_name}}</label>
            </div>
        {% endfor %}
    </div>

    <table class="table table-hover">
        <thead>
            <tr>
                <th>#</th>
                {% for f in fields %}
                    <th>{{f}}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in books %}
                <tr onclick="window.location='{% url 'book-detail' row.id %}?format=html';">

                    {% for key, value in row.items %}
                        <td>
                            {{value}}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}


        </tbody>

    </table>

    <div class="container">
        <form action="{% url 'book-list' %}?format=html" method="POST">
            {% csrf_token %}
            {% render_form create_form %}
            <button type="submit">Добавить</button>
        </form>
    </div>

    <script>
        function change_visible(id, visible){
            let xhr = new XMLHttpRequest();
            xhr.open('PATCH', "/profiles/"+id+"/");
            xhr.setRequestHeader("X-CSRFToken", '{{ csrf_token }}');
            xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
            xhr.send(JSON.stringify({'is_visible':!v}));
            xhr.onloadend = function() {
                if (xhr.status == 200) {
                    window.location.href = "{% url 'book-list' %}?format=html";
                } else {
                    alert(xhr.status+" "+xhr.response);
                }
             };
        };
    </script>

{% endblock %}